<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="format-detection" content="telephone=no" />
<meta name="renderer" content="webkit" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<link rel="alternate icon" type="image/png" href="assets/i/favicon.png" />
<link rel="stylesheet" href="assets/css/amazeui.min.css" />
<style type="text/css">
.p-select-color {
	background-color: #e2e2e2;
}

.p-unselect-color {
	background-color: #fff;
}

select {
	background: #fff;
	padding: 8px;
}

body {
	padding-left: 20px;
	padding-right: 20px;
	padding-top: 6px;
}

.am-form-label {
	padding-left: 0;
	padding-right: 0;
}

.am-form-group {
	padding: 0px;
}
</style>
</head>
<body>
	<script id="types" type="text/html"> 
<select id="se_type" name="bookType">
	<option value="">无</option>
 {{each data type i}} 
	<option value="{{type.bookType}}">{{type.bookType}}</option>
 {{/each}} 
</select> <span class="am-form-caret"></span>
</script>
	<script id="bjs" type="text/html"> 
<select id="se_bjs" name="bjsName">
	<option value="">无</option>
 {{each data bjs i}} 
	<option value="{{bjs.bjsName}}">{{bjs.bjsName}}</option>
 {{/each}} 
</select> <span class="am-form-caret"></span>
</script>
	<script id="books" type="text/html"> 
 {{each data b i}} 
	<tr class="tr-click" book_id="{{b.id}}">
				<td>{{b.bookNum}}</td>
				<td>{{b.bookName}}</td>
				<td>{{b.author}}</td>
				<td>{{b.publishDate}}</td>
				<td>{{b.bookType}}</td>
				<td>{{b.bjsName}}</td>
				<td>{{b.publishNum}}</td>
				<td>{{b.bookSize}}</td>
				<td>{{b.price}}</td>
				<td>{{b.editMan}}</td>
	</tr>
 {{/each}} 
</script>
	<div style="float: left; width: 30%">
		<div id="error" style="color: red; padding-bottom: 5px;">编辑</div>
		<form class="am-form am-form-horizontal" role="form" method="POST">
			<input type="hidden" value="0" name="id">
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">书名</label>
				<div class="am-u-sm-10">
					<input book_id="" name="bookName" type="text" class="am-form-field"
						placeholder="">
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">作者</label>
				<div class="am-u-sm-10">
					<input name="author" type="text" class="am-form-field"
						placeholder="">
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">书号</label>
				<div class="am-u-sm-10">
					<input name="bookNum" type="text" class="am-form-field"
						placeholder="">
				</div>
			</div>
			<div class="am-form-group ">
				<label class="am-form-label am-u-sm-2">出版时间</label>
				<div class="am-u-sm-10 am-form-icon">
					<input type="date" class="am-form-field am-input-md"
						name="publishDate" placeholder="时间">
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">印数</label>
				<div class="am-u-sm-10">
					<input name="publishNum" type="number" class="am-form-field"
						placeholder="">
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">开本</label>
				<div class="am-u-sm-10">
					<select name="bookSize">
						<option value="">无</option>
						<option value="16">16开</option>
						<option value="24">24开</option>
						<option value="32">32开</option>
						<option value="42">42开</option>
					</select>
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">定价</label>
				<div class="am-u-sm-10">
					<input name="price" type="number" class="am-form-field"
						placeholder="">
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">编辑室</label>
				<div id="div_bjs" class="am-u-sm-10"></div>
			</div>

			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">书籍类型</label>
				<div id="div_type" class="am-u-sm-10"></div>
			</div>
			<div class="am-form-group">
				<label class="am-form-label am-u-sm-2">责任编辑</label>
				<div class="am-u-sm-10">
					<select name="editMan">
						<option value="">无</option>
						<option value="老王">老王</option>
						<option value="老李">老李</option>
						<option value="老花">老花</option>
						<option value="麻子">麻子</option>
					</select>
				</div>
			</div>
			<div class="am-form-group">
				<label class="am-radio-inline"> <input type="radio"
					value="desc" name="sort" checked="checked"> 降序
				</label> <label class="am-radio-inline"> <input type="radio"
					value="asc" name="sort"> 升序
				</label>
			</div>
			<button id="btn0" class="am-btn am-btn-default">增加</button>
			<button id="btn1" class="am-btn am-btn-default">修改</button>
			<button id="btn2" class="am-btn am-btn-default">删除</button>
			<button id="btn3" class="am-btn am-btn-default">查询</button>
			<button id="btn4" class="am-btn am-btn-default">放弃</button>
		</form>
	</div>
	<div style="float: left; width: 70%">
		<table class="am-table am-table-hover am-table-compact">
			<thead>
				<tr>
					<th>书号</th>
					<th>书名</th>
					<th>作者</th>
					<th>出版时间</th>
					<th>图书分类</th>
					<th>编辑室</th>
					<th>印数</th>
					<th>开版</th>
					<th>定价</th>
					<th>责任编辑</th>
				</tr>
			</thead>
			<tbody id="tb_data">
			</tbody>
		</table>
	</div>
	<script th:src="@{/assets/js/jquery.min.js}"></script>
	<script th:src="@{/assets/js/amazeui.min.js}"></script>
	<script th:src="@{/assets/js/template-web.js}"></script>
	<script th:src="@{/assets/mine/helper.js}"></script>
	<script type="text/javascript">
		var urlAdd = "/book/addBook";
		var urlDel = "/book/delBook";
		var urlUpdate = "/book/updateBook";
		var urlQuery = "/book/query";
		var urlGetOne = "/book/getOneBook";
		var urlGetBjs = "/book/getBjs";
		var urlGetBookType = "/book/getBookType";
		var urlGetBooks = "/book/getBooks";
		$(function() {
			//一开始时只有增加和查询可用
			disableBtn([ 0, 1, 1, 0, 1 ]);

			loadBjs();
			loadType();
			loadBooks();

			//当表格的一行被点击时，选中该行，加载书籍到表单中，同时设置相应的按钮状态
			$("#tb_data").on('click', ".tr-click", function() {
				var t = $(this);
				$("tr").removeClass("p-select-color");
				t.addClass("p-select-color");
				var id = t.attr("book_id");
				addToForm(id);
				//更新按钮
				disableBtn([ 0, 0, 0, 0, 0 ]);
			})

			//add
			$("#btn0").on('click', function() {
				var form_data = $("form").serializeArray();
				if (checkForm(form_data)) {
					console.log(form_data)
					myAjax(urlAdd, form_data, function(re) {
						$("form")[0].reset();
						loadBooks();
					});
				}
				return false;
			})
			//delete
			$("#btn2").on('click', function() {
				var ok = confirm("确定删除本书吗？不可恢复哦");
				if (ok) {
					var id = $("[name=id]").val();
					myAjax(urlDel, {
						id : id
					}, function(re) {
						initial();
						loadBooks();
					});
				}
				return false;
			})
			//update
			$("#btn1").on('click', function() {
				var form_data = $("form").serializeArray();
				console.log(form_data)
				if (checkForm(form_data)) {
					myAjax(urlUpdate, form_data, function(re) {
						initial();
						loadBooks();
					});
				}
				return false;
			})
			//query
			$("#btn3").on('click', function() {
				var form_data = $("form").serializeArray();
				console.log(form_data)
				myAjax(urlQuery, form_data, function(re) {
					//				initial();
					var html = template('books', re);
					$("#tb_data").html(html);
					disableBtn([ 0, 1, 1, 0, 0 ]);
				});
				return false;
			})
			//give up
			$("#btn4").on('click', function() {
				initial();
				loadBooks();
				return false;
			});
		});
		/**加载编辑室
		 */
		function loadBjs() {
			myAjax(urlGetBjs, {}, function(re) {
				var html = template('bjs', re);
				$("#div_bjs").html(html);
			});
		}
		//加载书籍类型
		function loadType() {
			myAjax(urlGetBookType, {}, function(re) {
				var html = template('types', re);
				$("#div_type").html(html);
			});
		}
		//加载书籍列表
		function loadBooks() {
			myAjax(urlGetBooks, {}, function(re) {
				var html = template('books', re);
				$("#tb_data").html(html);
			});
		}
		//设置按钮禁用状态
		function disableBtn(arr) {
			for (var i = 0; i < arr.length; i++) {
				if (arr[i] === 1) {
					$("#btn" + i).attr("disabled", true);
				} else {
					$("#btn" + i).attr("disabled", false);
				}
			}
		}
		//根据id将书的信息加载到表单
		function addToForm(id) {
			myAjax(urlGetOne, {
				id : id
			}, function(re) {
				var d = re.data;
				$("[name=bookName]").val(d.bookName);
				$("[name=id]").val(d.id);
				$("[name=author]").val(d.author);
				$("[name=bookNum]").val(d.bookNum);
				$("[name=bookSize]").val(d.bookSize);
				$("[name=publishDate]").val(d.publishDate);
				$("[name=publishNum]").val(d.publishNum);
				$("[name=price]").val(d.price);
				$("[name=editMan]").val(d.editMan);
				$("#se_type").val(d.bookType);
				$("#se_bjs").val(d.bjsName);
			});
		}

		//对表单提交的东西进行验证
		function checkForm(form) {
			/* for ( var i in form) {
				var f = form[i];
				console.log(f)
				if (f.value == "") {
					$("[name=" + f.name + "]").focus();
					return false;
				}
			} */
			var v = $("[name=bookName]");
			if (v.val() == "") {
				v.focus();
				$("#error").html("书名不能为空");
				return false;
			}
			v = $("[name=bookNum]");
			if (v.val() == "") {
				v.focus();
				$("#error").html("书号不能为空");
				return false;
			}
			var f = /^\d+\.[0-9][0-9]$/
			v = $("[name=price]");
			if (!f.test(v.val())) {
				v.focus();
				$("#error").html("请输入合法金额");
				return false;
			}
			v = $("[name=publishDate]");
			if (v.val() == "") {
				v.focus();
				$("#error").html("请选择合法日期");
				return false;
			}
			f = /^[1-9]\d*$/
			v = $("[name=publishNum]");
			if (!f.test(v.val())) {
				v.focus();
				$("#error").html("请输入合法印数");
				return false;
			}

			return true;
		}

		//初始化
		function initial() {
			$("form")[0].reset();
			$("tr").removeClass("p-select-color");
			$("#error").html("编辑");
			disableBtn([ 0, 1, 1, 0, 1 ]);
		}
	</script>
</body>
</html>
